<p align="center">
  <img src="https://raw.githubusercontent.com/mkopsnc/marmot/main/images/marmot.png">
</p>

# Marmot

Sample code illustrating the way of wrapping `Fortran` code inside `Python`. In the execution process we go all the way down via `C` bindings.

```
Python -> C layer (shared library) -> Fortran (static library)
```

This project is compatible with `macOS` and `Linux`.

# Requirements

* `Python 3.8`
* `GNU Fortran 8.3.0`
* `GNU C 8.3.0`
* `venv`
* `GNU Make`
* `MPICH 3.3.1`

## Wrappers based on `iso_c_binding`

### Building

Building whole project is quite simple. Clone the project

```
> git clone https://github.com/mkopsnc/marmot.git
```

Once it is in place build the code. Please note that this is very simple project and you can use either `float` or `int` based samples at a time.

#### Integer based code

```
> cd marmot/iso_c_binding_sample_int
> ./build.sh
```

#### Float based code

```
> cd marmot/iso_c_binding_sample_float
> ./build.sh
```

This will build all the components that are part of the solution (only native code is build). After native code is in place, you can import `pip` based Python wrappers into your virtual environment.

### Installing inside venv

```
> python3 -m venv venv-38
> source venv-38/bin/activate

# If you want to run MPI code you have to install `mpi4py`
> pip3 install mpi4py

> pip3 install --upgrade --force-reinstall `pwd`/distance/distance_python
> pip3 install --upgrade --force-reinstall `pwd`/velocity/velocity_python

# MPI code is optional - if you don't have MPI installed you can skip this step
> pip3 install --upgrade --force-reinstall `pwd`/velocity_mpi/velocity_mpi_python
```

Above steps will install Python modules together with native code. You are ready to use wrappers inside Python.

### Running the code

```
from distance_wrapper.actor import distance
from velocity_wrapper.actor import velocity

print('Distance: ', distance( 20.0, 2.0 ))
print('Velocity: ', velocity( distance( 20.0, 2.0 ), 2.0) )
```

Alternativelly, run

```
> python3 ./run_codes.py
```

To run `MPI` based example, execute:

```
> mpirun -np 4 python ./run_codes_mpi.py
```

## Wrappers generated by f90wrap

### Prerequisite

Installation of `f90wrap`

```
> cd marmot/f90wrap_sample
> python3 -m venv venv-38
> export VENV_38=`pwd`/venv-38
> source venv-38/bin/activate
> pip install numpy
> export GFORTRAN_HOME=/whatever/the/location/of/gfortran/you/have
> F90=${GFORTRAN_HOME}/bin/gfortran-8.3.0 pip install f90wrap
```

### Building the code

In order to build `f90wrap` based codes (Python wrapper) we have to point `f90wrap` to the source code.

```
> ./build.sh
> mkdir dist
> CC=${GFORTRAN_HOME}/bin/gcc-8.3.0 \
  FC=${GFORTRAN_HOME}/bin/gfortran-8.3.0 \
  ${VENV_38}/bin/f2py-f90wrap --build-dir distance_wrapper \
  -c -m distance \
  -Idistance/distance_fortran/include \
  distance/distance_fortran/src/distance/distance.F90
> rm -rf distance_wrapper
> mv distance.cpython* dist
> CC=${GFORTRAN_HOME}/bin/gcc-8.3.0 \
  FC=${GFORTRAN_HOME}/bin/gfortran-8.3.0 \
  ${VENV_38}/bin/f2py-f90wrap --build-dir velocity_wrapper \
  -c -m velocity \
  -Ivelocity/velocity_fortran/include \
  velocity/velocity_fortran/src/velocity/velocity.F90
> rm -rf velocity_wrapper
> mv velocity.cpython* dist
```

### Running the code

In order to run the code we have to make sure both libraries `distance` and `velocity` are visible via `PYTHONPATH`.

```
> export PYTHONPATH=`pwd`/dist:${PYTHONPATH}
```

once everything is in place, we can run the code

```
> ptyhon ./run_codes.py
```
